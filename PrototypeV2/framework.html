<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>3D Medicine Rack</title>
        <style>
            body
            {
                margin:0;
                overflow:hidden;
                font-family:Arial;
            }
            #toggleHUD
            {
                padding:6px 10px;
                border:none;
                border-radius:6px;
                background:#444;
                color:white;
                cursor:pointer;
            }
            #buttonTog
            {
                position:absolute;
                top:10px;
                left:10px;
            }
            #buttonTog:hover
            {
                opacity:0.8;
            }
            #hud
            {
                position:absolute;
                top:50px;
                left:10px;
                background:rgba(255,255,255,0.9);
                padding:10px;
                border-radius:6px;
                font-size:14px;
            }
            #manualPnl
            {
                position:absolute;
                top:10px;
                right:10px;
                width:220px;
                max-height:90vh;
                background:rgba(255,255,255,0.9);
                padding:10px;
                border-radius:6px;
                overflow-y:auto; /* allows scrolling */
                font-size:14px;
            }
            #mt
            {
                text-align:center;
                font-size:medium;
            }
        </style>
    </head>
    <body>
        <div id="buttonTog"><button id="toggle">Toggle HUD</button><button id="auto">Start Auto</button></div>
        <div id="hud"></div>
        <div id="manualPnl">
            <div id="mt">Place Arrival/Customer Order
                <label>Lokasi:</label><br>
                <select id="boxSelect"></select><br>
                <label>Qty:</label><br>
                <input type="number" id="pickQty" value="1" min="1" style="width:60px"><br><br>
                <button onclick="addPick2()">Restock</button>
                <button onclick="addPick()">Consumption</button>
                <div id="pickList"> ===Belum ada item=== </div>
                    <button onclick="submitManualBatch()">Submit</button>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
        <script src="rack.js"></script>
        <script src="functions.js"></script>
        <script>
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf2f2f2);
            const camera = new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,100);
            camera.position.set(0,6,9);
            camera.lookAt(0,2.5,0);
            const renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth,window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff,0.6));
            const dirLight=new THREE.DirectionalLight(0xffffff,0.8);
            dirLight.position.set(5,10,5);
            scene.add(dirLight);
            //Rack
            const {rackGroup,boxObjects}=createMedicineRack();
            window.boxObjects = boxObjects; //Manual Purpose
            scene.add(rackGroup);
            //Worker visuals
            createWorkerShadow(scene);
            createSearchIndicator(scene);
            populateLocationDropdown(boxObjects);
            //HUD
            function updateHUD()
            {
                let html=`<strong>Runtime:</strong> ${simulationTime.toFixed(1)}s<br><br>`;
                html+=`<strong>Last Delivery:</strong> ${lastDeliverySummary}<br>`;
                html+=`<strong>Arrival Worker:</strong> ${arrivalWorker.state}<br><br>`;
                html+=`<strong>Last Order:</strong> ${lastOrderSummary}<br>`;
                html+=`<strong>Order Worker:</strong> ${orderWorker.state}<br><br>`;
                html+=`<strong>Overflow Queue:</strong> ${overflowQueue.map(o=>o.id+"("+o.qty+")").join(", ") || "Empty"}<br><br>`;
                boxObjects.forEach(b=>{ html+=`${b.id}: ${b.count}/${b.capacity}<br>`; });
                document.getElementById("hud").innerHTML=html;
                if(!hudVisible) return;
            }
            //Toggles or Buttons
            let hudVisible = true;
            document.getElementById("toggle").addEventListener("click", () =>
            { hudVisible = !hudVisible; document.getElementById("hud").style.display = hudVisible ? "block" : "none"; });
            let automationRunning = false;
            document.getElementById("auto").addEventListener("click", () =>
            {
                automationRunning = !automationRunning;
                document.getElementById("auto").textContent = automationRunning ? "Stop Auto" : "Start Auto";
            });
            //Sim Loops
            setInterval(()=>{ if(automationRunning) processDelivery(boxObjects); updateBoxes(boxObjects); },5000); //Delivery Loop
            setInterval(()=>{ if(automationRunning) processOrder(boxObjects); updateBoxes(boxObjects); },7000); //Order Loop
            setInterval(()=>{ checkReorderTriggers(boxObjects); },100); //Failsafe1 checker
            setInterval(()=>{ processSupplierQueue(); },3000); //Failsafe1: Emergency restock
            setInterval(()=>{ if(automationRunning) processOverflow(boxObjects); },2000); //Failsafe2: Too much stock
            //setInterval(()=>{ tickSimulation(0.1); },100); //Simulation Tick Show (Debug Purp), comment to end
            setInterval(()=>{ updateHUD(); },100); //HUD Update
            //Resize
            window.addEventListener("resize",()=>{
            camera.aspect=window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth,window.innerHeight);
            });
            //Animating
            function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera);}
            updateHUD();
            animate();
        </script>
    </body>
</html>
